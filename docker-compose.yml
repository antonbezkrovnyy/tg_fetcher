version: '3.8'

# Telegram Fetcher Service
# Connects to shared TG Infrastructure Stack (tg-infra)
# External network: tg-infrastructure

services:
  # === Telegram Fetcher Service (Daemon Mode) ===
  telegram-fetcher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-fetcher
    # Run in daemon mode (listens for Redis commands)
    command: ["python", "-m", "src.daemon"]
    env_file:
      - .env
    environment:
      # Redis connection (commands queue & events)
      - REDIS_URL=redis://tg-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # Observability stack connection
      - LOKI_URL=http://tg-loki:3100
      - PUSHGATEWAY_URL=http://tg-pushgateway:9091
      - PROMETHEUS_URL=http://tg-prometheus:9090

      # Service metadata
      - SERVICE_NAME=telegram-fetcher
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - HOSTNAME=telegram-fetcher-1

      # Logging & Metrics
      - LOG_FORMAT=json
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENABLE_METRICS=true
    volumes:
      - ./data:/app/data  # Includes progress.json inside data/
      - ./sessions:/app/sessions
    networks:
      - tg-infrastructure
    restart: unless-stopped  # Daemon mode: run continuously
    # For one-shot mode (old behavior), use: command: ["python", "-m", "src.main"]

# === Networks ===
networks:
  tg-infrastructure:
    external: true
    name: tg-infrastructure
